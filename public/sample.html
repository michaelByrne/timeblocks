<head>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.12/d3.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.7/d3-tip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.2/TweenMax.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<section id="intro">
  <h1>Climate Representation in the United States 2017</h1>
</section>

<div id="map"></div>
<div id="legend"></div>
<script>


  var width = 700;
  var height = 400;
  var svg = d3.select("#map")
          .append("svg")
          .attr("width", width)
          .attr("height", height);


  var colorScale = ['#F64710', '#FFD4A6'];
  var color = d3.scale.linear()
          .domain([0.0, 1.0])
          .range(colorScale);
  var data = d3.map();
  console.log(data);
  var projection = d3.geo.equirectangular()
          .center([-96.03542, 41.69553])
          .scale(2000)
          .translate([width / 2, height / 2]);

  var path = d3.geo.path()
          .projection(projection);

  var tip = d3.tip()
          .attr('class', 'd3-tip')
          .offset([-20, 0])
          .html(function (d) {
            console.log(data.get(d.properties.abbr));
            return "<strong>" + d.properties.name + "<br> </strong><span> Total congressional seats: " + data.get(d.properties.abbr)[1] +
                    "<br>Voted against climate change legislation: " + data.get(d.properties.abbr)[2] +
                    "<br>Denied climate change exists: " + data.get(d.properties.abbr)[3] +
                    "<br>Total climate score: " + data.get(d.properties.abbr)[0]*100 + "</span><br>"
          });

  queue()
          .defer(d3.json, "http://rawgit.com/geobabbler/us-state-squares/380435e6d7295251519797ecc38d3ee91fb05a01/state_squares.geojson")
          .defer(d3.csv, "data.csv", function (d) {
            data.set(d.state, [d.ratio, d.total, d.vote, d.deny]);
          })
          .await(ready);

  function ready(error, d) {
    svg.append('g')
            .attr('class', 'states')
            .selectAll('path')
            .data(d.features)
            .enter()
            .append('path')
            .attr('class', function (d) {
              return d.properties.abbr;
            })
            .attr('fill', function (d) {
              return color(data.get(d.properties.abbr)[0])
            })
            .attr('d', path)
            //.on('mouseover', tip.show)
            .on('mouseover', function(d){
              tip.show(d);
              d3.select(this).attr('stroke', '#000').attr('stroke-width','2.5px');
            })
            .on('mouseout', function(d){
              tip.hide(d);
              d3.select(this).attr('stroke', 'none');
            });

    svg.selectAll('.place-label')
            .data(d.features)
            .enter()
            .append('text')
            .attr('class', 'place-label')
            .attr('transform', function (d) {
              return 'translate(' + path.centroid(d) + ')';
            })
            .attr('dy', '.5em')
            .attr('dx', '-.7em')
            .text(function (d) {
              return d.properties.abbr;
            })
  }

  svg.call(tip);

  var w = 285, h = 40;
  var key = d3.select('#legend')
          .append('svg')
          .attr('width', w)
          .attr('height', h);

  var legend = key.append('defs')
          .append('svg:linearGradient')
          .attr('id', 'gradient')
          .attr('y1', '100%')
          .attr('x1', '0%')
          .attr('y2', '100%')
          .attr('x2', '100%')
  legend.append('stop')
          .attr('offset', '0%')
          .attr('stop-color', colorScale[0])
  legend.append('stop')
          .attr('offset', '100%')
          .attr('stop-color', colorScale[1])
  key.append('rect')
          .attr('width', w - 10)
          .attr('height', h - 20)
          .style('fill', 'url(#gradient)')
          .attr('transform', 'translate(0,20)');


  var y = d3.scale.linear()
          .range([0, 250])
          .domain([0, 100]);

  var yAxis = d3.svg.axis()
          .scale(y)
          .ticks(4);
  key.append('g')
          .attr('class', 'y axis')
          .attr('transform', 'translate(10,15)')
          .call(yAxis);


</script>


</body>